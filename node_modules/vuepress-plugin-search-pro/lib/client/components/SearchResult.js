import{useLocaleConfig as Z,isString as ee,isPlainObject as te}from"@vuepress/helper/client";import{useLocalStorage as E,useDebounceFn as se,useEventListener as le}from"@vueuse/core";import{ref as q,shallowRef as re,onMounted as ae,watch as F,onUnmounted as ue,defineComponent as ie,toRef as oe,reactive as ne,computed as O,h as s}from"vue";import{useRouteLocale as _,usePageData as ce,useRouter as ve,RouteLink as U}from"vuepress/client";import{H as M,C as Y,S as pe,T as he,a as ye,b as de}from"../closeIcon-3ghKBQ2r.js";import{s as P,u as me,c as fe,a as ge,b as He}from"../index-DuYfQ8Y8.js";import"../styles/search-result.scss";import{store as Re}from"@temp/search-pro/store.js";import"vuepress-shared/client";const Se="SEARCH_PRO_QUERY_HISTORY",y=E(Se,[]),Qe=()=>{const{queryHistoryCount:l}=P,r=l>0;return{enabled:r,queryHistory:y,addQueryHistory:a=>{r&&(y.value.length<l?y.value=Array.from(new Set([a,...y.value])):y.value=Array.from(new Set([a,...y.value.slice(0,l-1)])))},removeQueryHistory:a=>{y.value=[...y.value.slice(0,a),...y.value.slice(a+1)]}}},D=l=>Re[l.id]+("anchor"in l?`#${l.anchor}`:""),ke="SEARCH_PRO_RESULT_HISTORY",{resultHistoryCount:I}=P,d=E(ke,[]),Ce=()=>{const l=I>0;return{enabled:l,resultHistory:d,addResultHistory:r=>{if(l){const a={link:D(r),display:r.display};"header"in r&&(a.header=r.header),d.value.length<I?d.value=[a,...d.value]:d.value=[a,...d.value.slice(0,I-1)]}},removeResultHistory:r=>{d.value=[...d.value.slice(0,r),...d.value.slice(r+1)]}}},xe=l=>{const r=me(),a=_(),C=ce(),i=q(!1),f=re([]);return ae(()=>{const{search:R,terminate:m}=fe(),S=()=>{f.value=[],i.value=!1},g=se(p=>{i.value=!0,p?R(p,a.value,r.value).then(h=>r.value.searchFilter?.(h,p,a.value,C.value)??h).then(h=>{f.value=h,i.value=!1}).catch(h=>{console.error(h),S()}):S()},P.searchDelay);F([l,a],()=>g(l.value),{immediate:!0}),ue(()=>{m()})}),{searching:i,results:f}};var we=ie({name:"SearchResult",props:{query:{type:String,required:!0},isFocusing:Boolean},emits:["close","updateQuery"],setup(l,{emit:r}){const a=ve(),C=_(),i=Z(ge),{enabled:f,addQueryHistory:R,queryHistory:m,removeQueryHistory:S}=Qe(),{enabled:g,resultHistory:p,addResultHistory:h,removeResultHistory:j}=Ce(),T=f||g,x=oe(l,"query"),{results:H,searching:V}=xe(x),u=ne({isQuery:!0,index:0}),c=q(0),v=q(0),$=O(()=>T&&(m.value.length>0||p.value.length>0)),w=O(()=>H.value.length>0),L=O(()=>H.value[c.value]||null),W=()=>{const{isQuery:e,index:t}=u;t===0?(u.isQuery=!e,u.index=e?p.value.length-1:m.value.length-1):u.index=t-1},B=()=>{const{isQuery:e,index:t}=u;t===(e?m.value.length-1:p.value.length-1)?(u.isQuery=!e,u.index=0):u.index=t+1},N=()=>{c.value=c.value>0?c.value-1:H.value.length-1,v.value=L.value.contents.length-1},z=()=>{c.value=c.value<H.value.length-1?c.value+1:0,v.value=0},G=()=>{v.value<L.value.contents.length-1?v.value+=1:z()},J=()=>{v.value>0?v.value-=1:N()},b=e=>e.map(t=>ee(t)?t:s(t[0],t[1])),K=e=>{if(e.type==="customField"){const t=He[e.index]||"$content",[o,k=""]=te(t)?t[C.value].split("$content"):t.split("$content");return e.display.map(n=>s("div",b([o,...n,k])))}return e.display.map(t=>s("div",b(t)))},Q=()=>{c.value=0,v.value=0,r("updateQuery",""),r("close")};return le("keydown",e=>{if(l.isFocusing){if(w.value){if(e.key==="ArrowUp")J();else if(e.key==="ArrowDown")G();else if(e.key==="Enter"){const t=L.value.contents[v.value];R(l.query),h(t),a.push(D(t)),Q()}}else if(g){if(e.key==="ArrowUp")W();else if(e.key==="ArrowDown")B();else if(e.key==="Enter"){const{index:t}=u;u.isQuery?(r("updateQuery",m.value[t]),e.preventDefault()):(a.push(p.value[t].link),Q())}}}}),F([c,v],()=>{document.querySelector(".search-pro-result-list-item.active .search-pro-result-item.active")?.scrollIntoView(!1)},{flush:"post"}),()=>s("div",{class:["search-pro-result-wrapper",{empty:x.value?!w.value:!$.value}],id:"search-pro-results"},x.value===""?T?$.value?[f?s("ul",{class:"search-pro-result-list"},s("li",{class:"search-pro-result-list-item"},[s("div",{class:"search-pro-result-title"},i.value.queryHistory),m.value.map((e,t)=>s("div",{class:["search-pro-result-item",{active:u.isQuery&&u.index===t}],onClick:()=>{r("updateQuery",e)}},[s(M,{class:"search-pro-result-type"}),s("div",{class:"search-pro-result-content"},e),s("button",{class:"search-pro-remove-icon",innerHTML:Y,onClick:o=>{o.preventDefault(),o.stopPropagation(),S(t)}})]))])):null,g?s("ul",{class:"search-pro-result-list"},s("li",{class:"search-pro-result-list-item"},[s("div",{class:"search-pro-result-title"},i.value.resultHistory),p.value.map((e,t)=>s(U,{to:e.link,class:["search-pro-result-item",{active:!u.isQuery&&u.index===t}],onClick:()=>{Q()}},()=>[s(M,{class:"search-pro-result-type"}),s("div",{class:"search-pro-result-content"},[e.header?s("div",{class:"content-header"},e.header):null,s("div",e.display.map(o=>b(o)).flat())]),s("button",{class:"search-pro-remove-icon",innerHTML:Y,onClick:o=>{o.preventDefault(),o.stopPropagation(),j(t)}})]))])):null]:i.value.emptyHistory:i.value.emptyResult:V.value?s(pe,{hint:i.value.searching}):w.value?s("ul",{class:"search-pro-result-list"},H.value.map(({title:e,contents:t},o)=>{const k=c.value===o;return s("li",{class:["search-pro-result-list-item",{active:k}]},[s("div",{class:"search-pro-result-title"},e||i.value.defaultTitle),t.map((n,X)=>{const A=k&&v.value===X;return s(U,{to:D(n),class:["search-pro-result-item",{active:A,"aria-selected":A}],onClick:()=>{R(l.query),h(n),Q()}},()=>[n.type==="text"?null:s(n.type==="title"?he:n.type==="heading"?ye:de,{class:"search-pro-result-type"}),s("div",{class:"search-pro-result-content"},[n.type==="text"&&n.header?s("div",{class:"content-header"},n.header):null,s("div",K(n))])])})])})):i.value.emptyResult)}});export{we as default};
//# sourceMappingURL=SearchResult.js.map
